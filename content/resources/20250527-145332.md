---
title: How I Used O3 to Find CVE-2025-37899
draft: false
date: 2024-06-04
tags:
  - o3
  - vulnerability research
  - Linux kernel
---

In this post, I'll show you how I found a problem in the Linux kernel using OpenAI's o3 model. I found the problem using just the o3 tool, without anything complicated.

I've been checking ksmbd for problems. ksmbd is "a Linux kernel server that lets you share files over a network." I started this project to take a break from working with computer programs, but after o3 came out, I wanted to see if it could find the problems I had already found in ksmbd. In the future, I'll talk about how well o3 did with all of those problems, but here, we'll focus on how o3 found a new problem while I was testing it. The problem it found is CVE-2025-37899, a mistake in how the system handles the SMB 'logoff' command. To understand the problem, you need to think about how different connections to the server can share things. o3 was able to understand this and find a place where something was being deleted while another part of the system could still access it. As far as I know, this is the first time a computer program has found a problem like this.

The main thing to take away from this post is that o3 has made computer programs much better at understanding code. If you work on finding problems in computer systems, you should start paying attention. If you're an expert at finding and fixing problems, these programs aren't going to replace you. Instead, they can help you do your job much faster and better. If you have a problem that can be shown in less than 10,000 lines of code, there's a good chance o3 can either solve it or help you solve it.

## Testing o3 using CVE-2025-37778

First, let's talk about CVE-2025-37778, a problem that I found myself. I was using this problem to test o3 when it found the new problem, CVE-2025-37899.

CVE-2025-37778 is a mistake where something is used after it has been deleted. The problem happens when the system is checking who someone is using Kerberos, during a "session setup" request from a computer far away. To make things easier, I'll call this problem the "Kerberos authentication problem."

The problem is like this:

|     |     |
| --- | --- |
| 1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15 | `static` `int` `krb5_authenticate(` `struct` `ksmbd_work *work,`<br>`                 ``struct` `smb2_sess_setup_req *req,`<br>`                 ``struct` `smb2_sess_setup_rsp *rsp)`<br>`{`<br>`...`<br>`    ``if` `(sess->state == SMB2_SESSION_VALID) `<br>`        ``ksmbd_free_user(sess->user);`<br>`    `<br>`    ``retval = ksmbd_krb5_authenticate(sess, in_blob, in_len,`<br>`                     ``out_blob, &out_len);`<br>`    ``if` `(retval) {`<br>`        ``ksmbd_debug(SMB, ` `"krb5 authentication failed\n"` `);`<br>`        ``return` `-EINVAL;`<br>`    ``}`<br>`...` |

If `krb5_authenticate` sees that the session is `SMB2_SESSION_VALID`, it deletes `sess->user`. It seems like it's expected that `ksmbd_krb5_authenticate` will give it a new value, or that `sess->user` won't be used after `krb5_authenticate` returns `-EINVAL`. But this isn't true. We can make `ksmbd_krb5_authenticate` not give `sess->user` a new value, and we can still use `sess->user` even if `krb5_authenticate` returns `-EINVAL`.

This problem is a good way to test computer programs because:

1.  It's interesting because it's a way to attack the Linux kernel from far away.
2.  It's not easy because you need to:

    *   (a) Figure out how to make `sess->state == SMB2_SESSION_VALID` to make the system delete `sess->user`.
    *   (b) Realize that there are ways in `ksmbd_krb5_authenticate` that don't give `sess->user` a new value, and figure out how to make those ways happen.
    *   (c) Realize that there are other parts of the system that might use `sess->user` after it has been deleted.
3.  It's not too hard. I could explain the whole thing to someone in 10 minutes, and you don't need to know a lot about the Linux kernel, the SMB system, or ksmbd, except for how it handles connections and sets up sessions. I figured out that you would need to read about 3,300 lines of code if you read every ksmbd function from when the system gets a packet to when the problem happens.

So, we have a problem we want to use to test. What code do we show the computer program to see if it can find it? I want to see how o3 would do if it were part of a system that automatically finds problems. So, we need to know how such a system would choose what to show o3. It's not helpful to just pick functions to show the computer program if we don't know how an automated system would pick those functions. The best way to use a computer program like this is to give it all the code from a project, and it figures things out. But because of limits, this isn't possible right now.

Instead, I thought one way to do it was to show the computer program each SMB command handler separately. So, I gave the computer program the code for the 'session setup' command handler, including all the code for the functions it uses, up to a certain level. I also included all the code for the functions that read data, figure out what the data means, choose the command handler, and then close the connection. Without this, the computer program would have to guess how things are set up, which would cause more mistakes. In the end, this is about 3,300 lines of code, and we can use this to compare o3 with other programs. If you want, the code is [here](https://github.com/SeanHeelan/o3_finds_cve-2025-37899/blob/master/session_setup_code.prompt) as a single file.

The last thing is what to tell the computer program. You can find the instructions and other information I gave the computer program in the files in [this](https://github.com/SeanHeelan/o3_finds_cve-2025-37899) Github place. The important things are:

1.  I told the computer program to look for problems where something is used after it has been deleted.
2.  I gave it a short explanation of what ksmbd is, how it's set up, and what it's trying to protect against.
3.  I tried to make it not report mistakes, and to prefer not reporting any problems over reporting mistakes. I don't know if this helps, but I hope it does.

To run the test, I used the `llm` tool ( [github](https://github.com/simonw/llm)) like this:

```
$ llm --sf system_prompt_uafs.prompt                \
        -f session_setup_code.prompt                \
        -f ksmbd_explainer.prompt                   \
        -f session_setup_context_explainer.prompt   \
        -f audit_request.prompt
```

My test runs this many times (100 times for this test) and saves the results. If you run this yourself, you might not get the same results as me because I had to recreate the code file.

o3 finds the Kerberos authentication problem in 8 out of 100 runs. In 66 of the runs, o3 says there is no problem (false negatives), and the other 28 reports are mistakes (false positives). For comparison, Claude Sonnet 3.7 finds it 3 out of 100 runs, and Claude Sonnet 3.5 doesn't find it in 100 runs. So, o3 is about 2-3 times better than Claude Sonnet 3.7.

If you're interested, you can see a report from o3 ( [here](https://github.com/SeanHeelan/o3_finds_cve-2025-37899/blob/master/o3_finds_CVE-2025-37778.txt)) and Sonnet 3.7 ( [here](https://github.com/SeanHeelan/o3_finds_cve-2025-37899/blob/master/claude_3_7_finds_CVE-2025-37778.txt)). The way they show the results is interesting. o3 gives you something that looks like a bug report written by a person, while Sonnet 3.7 gives you something like a stream of thoughts. Both have good and bad points. o3's output is usually easier to understand, but sometimes it's too short and not clear enough.

## o3 finds a new problem (CVE-2025-37899)

After seeing that o3 could find the Kerberos authentication problem (CVE-2025-37778) when given the code for the session setup command handler, I wanted to see if it could find it if I gave it the code for **all** of the command handlers. This is harder because the command handlers are all in one big file, which has about 9,000 lines of code. But if o3 can still find problems when given all of the handlers at once, then we can use o3 more easily.

I combined the code for all of the handlers with the code for setting up and closing connections, as well as the code for choosing the command handler. This ended up being about 12,000 lines of code, and I ran the test 100 times.

o3 finds the Kerberos authentication problem in 1 out of 100 runs, which is worse than before. But more interestingly, I found a report for a similar, new problem that I didn't know about. This problem is also because of deleting `sess->user`, but this time it's in the session logoff handler.

|     |     |
| --- | --- |
| 1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21 | `int` `smb2_session_logoff(` `struct` `ksmbd_work *work)`<br>`{`<br>`    ``struct` `ksmbd_conn *conn = work->conn;`<br>`    ``struct` `ksmbd_session *sess = work->sess;`<br>`    `<br>`    ``...`<br>`    `<br>`    ``ksmbd_close_session_fds(work);`<br>`    ``ksmbd_conn_wait_idle(conn);`<br>`    `<br>`    ``...`<br>`    `<br>`    ``down_write(&conn->session_lock);`<br>`    ``sess->state = SMB2_SESSION_EXPIRED;`<br>`    ``up_write(&conn->session_lock);`<br>`    ``if` `(sess->user) {`<br>`        ``ksmbd_free_user(sess->user);`<br>`        ``sess->user = NULL;`<br>`    ``}`<br>`    ``...` |

Here's how o3 explains the problem:

```
Short description
=================
While one ksmbd worker thread is still executing requests that use
sess‑>user, another thread that processes an SMB2 LOGOFF for the same
session frees that structure.  No synchronisation protects the pointer,
so the first thread dereferences freed memory – a classic
use‑after‑free that leads to kernel memory corruption and arbitrary code
execution in kernel context.

Affected code path
------------------
1.  A second transport is bound to an existing session
    (SMB 3.0 or later, `conn->binding == true`).

2.  Worker‑A (running on connection C2) receives any normal request
    (e.g. WRITE).
       • `smb2_check_user_session()` stores a pointer to the already
         existing `struct ksmbd_session` in `work->sess` and
         increments the session ref‑count, **but it does not take
         any reference on `sess->user`.**
       • The pointer to `sess` is kept for the whole request
         processing; every helper that needs authentication data
         accesses `sess->user` directly.

3.  Before Worker‑A finishes, Worker‑B (running on the first connection
    C1) processes an SMB2 ​LOGOFF for the same session and executes
    `smb2_session_logoff()` (smb2pdu.c).

Relevant part of smb2_session_logoff()
--------------------------------------

```c
	...
	if (sess->user) {
		ksmbd_free_user(sess->user);   /* (1) frees memory     */
		sess->user = NULL;             /* (2) clear the field  */
	}
	...
```

`ksmbd_free_user()` ultimately ends in simple `kfree(user)`.

4.  Worker‑B **does not wait for the other connections that are still
    using the session**; it only waits for running requests on *its own*
    connection (`ksmbd_conn_wait_idle(conn)`).

5.  Worker‑A continues to execute (e.g. inside `smb2_open()`,
   `smb2_write()`, …) and dereferences `sess->user`:

```c
/* examples (many of them) */
if (user_guest(sess->user))        ← dereference after free
ksmbd_compare_user(sess->user, …)
sess->user->uid
```

Because the memory was already `kfree()`‑ed in step (1) the access is to
freed memory.  Depending on exact timing it is either:

• a use‑after‑free (pointer still points into now‑reused slab object),
  enabling controlled kernel‑memory overwrite, or
• a NULL–deref (if Worker‑A reads after step (2)), still a DoS.
```

After reading this report, I think that computer programs will be very helpful in finding problems in the future. Even if o3 doesn't get any better, it would still be useful for people who find problems to use it.

One other interesting thing is that when I found the Kerberos authentication problem, I suggested this fix:

|     |     |
| --- | --- |
| 1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18 | `diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.c`<br>`index d24d95d15d87..57839f9708bb 100644`<br>`--- a/fs/smb/server/smb2pdu.c`<br>`+++ b/fs/smb/server/smb2pdu.c`<br>`@@ -1602,8 +1602,10 @@ static int krb5_authenticate(struct ksmbd_work *work,`<br>`    ``if (prev_sess_id && prev_sess_id != sess->id)`<br>`        ``destroy_previous_session(conn, sess->user, prev_sess_id);`<br>` `<br>`-   if (sess->state == SMB2_SESSION_VALID)`<br>`+   if (sess->state == SMB2_SESSION_VALID) {`<br>`        ``ksmbd_free_user(sess->user);`<br>`+       sess->user = NULL;`<br>`+   }`<br>` `<br>`    ``retval = ksmbd_krb5_authenticate(sess, in_blob, in_len,`<br>`                     ``out_blob, &out_len);`<br>`-- `<br>`2.43.0` |

When I read o3's bug report, I realized this wasn't enough. The logoff handler already sets `sess->user = NULL`, but it's still not safe because the SMB system lets two different connections connect to the same session. I had already used this to find a problem in ksmbd, but I didn't think of it when I was thinking about the Kerberos authentication problem.

I looked at o3's results from searching for the Kerberos authentication problem again and saw that in some reports it had made the same mistake as me, but in others it hadn't. It realized that setting `sess->user = NULL` wasn't enough because of the possibility of connecting to the same session from different places. That's cool because it means that if I had used o3 to find and fix the original problem, I would have done a better job. I say 'in theory' because there are still too many mistakes compared to correct results, so I might not have been careful enough to see o3's solution. But that will get better.

## Conclusion

Computer programs like o3 are now much better at understanding code than anything else we've seen. They are more like human code checkers than other tools we have. Since GPT-4, there have been hints that computer programs could be useful in finding problems, but the results haven't been as good as we hoped. That has changed with o3.

o3 is not perfect. It can still make mistakes and be frustrating. But for the first time, it's worth trying to use it to solve real problems.

### Share this:

- [Facebook](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?share=facebook&nb=1)
- [X](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?share=x&nb=1)

LikeLoading...

[Reblog](https://widgets.wp.com/likes/index.html?ver=20250527# "Reblog this post on your main site.")

[Like](https://widgets.wp.com/likes/index.html?ver=20250527# "6 likes")

- [![nayan966](https://2.gravatar.com/avatar/eabbf439ef764cbcb6ad982f8a5e9158cf92b4fdc7c6fc1e6b4c02b83f563335?s=96&d=identicon&r=G)](https://gravatar.com/nayan966 "nayan966")
- [![corehacks](https://0.gravatar.com/avatar/9e7e2ebb24849e8a7cb9e302f0f9aa562ee89fe7d6c3df96cb5ebf174d892e57?s=96&d=identicon&r=G)](https://gravatar.com/corehacks "corehacks")
- [![yin sun](https://1.gravatar.com/avatar/4719fdb307758bbb974ac14d854e75c6d6a7acbfac9bff9a6bfcae28997e64ab?s=96&d=identicon&r=G)](https://gravatar.com/sunyin51 "yin sun")
- [![Mo Jangda](https://2.gravatar.com/avatar/ba312a0256a31564a11bf7f963aa96e76b4db2afa5530bc601b84ab9a0769b3d?s=96&d=identicon&r=G)](https://gravatar.com/batmoo "Mo Jangda")
- [![Phillip Stewart](https://2.gravatar.com/avatar/8369a4d267643e1f515aa5ec895b33fb1d8b33f45ab5b72694bb71c2942d8e30?s=96&d=identicon&r=G)](https://gravatar.com/phillipstewart7d4769bce2 "Phillip Stewart")

[6 likes](https://widgets.wp.com/likes/index.html?ver=20250527#)

### _Related_

[Game Over! Thank you for playing Academia](https://sean.heelan.io/2009/09/06/game-over-thank-you-for-playing-academia/ "Game Over! Thank you for playing&nbsp;Academia")September 6, 2009In "Exploit generation"

[ISSA Ireland seminar](https://sean.heelan.io/2009/05/06/issa-ireland-seminar/ "ISSA Ireland seminar")May 6, 2009In "Exploitation"

[Automatic exploit generation: Lessons learned so far](https://sean.heelan.io/2009/07/05/automatic-exploit-generation-lessons-learned-so-far/ "Automatic exploit generation: Lessons learned so&nbsp;far")July 5, 2009In "Exploit generation"

## 8 thoughts on “How I used o3 to find CVE-2025-37899, a remote zeroday vulnerability in the Linux kernel’s SMB implementation”

1. Have you tried OpenAI Codex? I tried this with the recently discovered virtualbox escape and found a bug that way.

[Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4807#respond)

   - Not yet. I assumed it was tuned towards code editing/writing and hadn’t thought to use it for bug hunting.

     [Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4810#respond)
2. The link to the sonnet 3.7 result doesn’t work as it doesn’t have the cve number in it

[Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4812#respond)

   - Fixed. Thanks!

     [Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4815#respond)
3. What was the compute cost to perform the analysis?

[Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4813#respond)

   - The 100 runs of the ~100k token version cost about $116.

     [Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4816#respond)
4. Super interesting research! Q1: Have you considered testing Gemini 2.5 Pro Preview model (leads WebDev Arena on LM Arena) or also its Deep Think version? Q2: What other models you may consider. Q3: Thoughts on Sonnet thinking mode? And Sonnet 4 is out and leads coding agent benchmarks, said to outperform Sonnet 3.7 and other models.

[Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4814#respond)

   - I haven’t tested Gemini 2.5 Pro yet, but I’m working on some new experiments and I’ll be sure to include it. I’m also planning to include the latest Sonnet and Opus models.

     [Reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/?replytocom=4817#respond)

### Leave a comment [Cancel reply](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/\#respond)

Write a comment...

Log in or provide your name and email to leave a comment.

Email me new posts

InstantlyDailyWeekly

Email me new comments

Save my name, email, and website in this browser for the next time I comment.

Comment

Δ

This site uses Akismet to reduce spam. [Learn how your comment data is processed.](https://akismet.com/privacy/)

[_Back to top_](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/#top)

- [Comment](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/#comments)
- [Reblog](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/)
- [Subscribe](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/) [Subscribed](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/)

- [![](https://sean.heelan.io/wp-content/uploads/2009/05/cropped-oxford_7602.jpg?w=50) Sean Heelan's Blog](https://sean.heelan.io/)

Join 40 other subscribers

Sign me up

- Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fsean.heelan.io%252F2025%252F05%252F22%252Fhow-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation%252F)

- [Privacy](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/#)
- - [![](https://sean.heelan.io/wp-content/uploads/2009/05/cropped-oxford_7602.jpg?w=50) Sean Heelan's Blog](https://sean.heelan.io/)
- [Subscribe](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/) [Subscribed](https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/)
- [Sign up](https://wordpress.com/start/)
- [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fsean.heelan.io%252F2025%252F05%252F22%252Fhow-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation%252F)
- [Copy shortlink](https://wp.me/pw5Z4-Mh)
- [Report this content](https://wordpress.com/abuse/?report_url=https://sean.heelan.io/2025/05/22/how-i-used-o3-to-find-cve-2025-37899-a-remote-zeroday-vulnerability-in-the-linux-kernels-smb-implementation/)
- [View post in Reader](https://wordpress.com/reader/