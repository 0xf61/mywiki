---
title: Cloudflare DNS management with Terraform
draft: false
date: 2024-01-29
tags:
  - cloudflare
  - terraform
---

# Cloudflare DNS management with Terraform

2022-11-20

I self-host many services. Sometimes I try out a few apps that might get deleted on the same day. All of this requires setting up a CNAME for reverse-proxy (because I want to make sure there are no strange reverse-proxy things happening, for future reference).

I can always log into the Cloudflare console and manually add CNAME entries, but this is becoming too tiring since all I really need is another CNAME with the same config as the rest of the CNAMEs - pointing to the same DNS for my home lab. I realized I can use Terraform to set it up.

It's as simple as:

```terraform
locals {
  selfhosted_proxied = toset([\
    "service_a", "service_b", "service_c",\
  ])
  selfhosted_non_proxied = toset([])
}
locals {
  proxied_dict     = { for name in local.selfhosted_proxied : name => true }
  non_proxied_dict = { for name in local.selfhosted_non_proxied : name => false }
  selfhosted_dns   = merge(local.proxied_dict, local.non_proxied_dict)
}

resource "cloudflare_record" "selfhosted_dns" {
  for_each = local.selfhosted_dns
  name     = each.key
  proxied  = each.value
  ttl      = 1
  type     = "CNAME"
  value    = var.ddns
  zone_id  = var.zone_id
}

```

It's really easy.

[Reference](https://karnwong.me/posts/rss.xml)
